{% extends "base.html" %}{% load static %}

{% block css %}
  <link rel="stylesheet" type="text/css" href="/static/css/dist/css_datepicker/bootstrap-datepicker.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/dist/css/bootstrap-select.min.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/adicionar_cliente.css" />

{% endblock %}


{% block loggedin %}
  <li><a>Usuário: {{ request.user.username }}</a></li>
  <li><a href="/logout" style="text-decoration: underline;">Sair</a></li>
{% endblock %}

{% block content %}
  <div class="my_menu">
    <div id="adicionar_message"><h3>Escolha o Cliente</h3></div>
  </div>
  <form action="./" method="GET">
    {% csrf_token %}
    <div style="text-align: center;" class="my_menu2">
      <h4>Insira nome e/ou telefone:</h4>
    </div>
    <div class="my_menu2">
      <div class="long-field input-group">
        <p>Nome:</p>
        <input type="text" class="field_sizing form-control" placeholder="Nome" aria-describedby="basic-addon1" name="nome">
      </div>
    </div>
    <div class="my_menu2">
      <div style="width:300px;" class="input-group">
        <p>Telefone:</p>
        <div style="display: flex; justify-content: space-between;">
          <input id="telefone" style="width:140px;" type="text" class="field_sizing form-control" placeholder="Telefone" aria-describedby="basic-addon1" name="telefone" onkeypress='return event.charCode >= 48 && event.charCode <= 57' onchange="brPhoneStyle(event)">
          <button style="width: 120px;" type="submit" class="btn btn-primary" name="button" value="filter">Procurar</button>
        </div>
      </div>
    </div>
  </form>
  {% if success == 2 %}
  <div>
    <form name="chooseClient" method="POST" onsubmit="return false;">
      {% csrf_token %}
      {% for i in filtered %}
        <div class="filtered">
          <div class="alert alert-info" role="alert">
            <div style="display: flex;">
              <div class="listing">
                <p><strong>Nome:</strong></p>
                <p>{{ i.nome|title }}</p>
              </div>
              <div class="listing">
                <p><strong>Telefone:</strong></p>
                <p>{{ i.telefone }}<input style="float:right; margin-top: 0" type="radio" name="cliente" value={{ i.id }}></p>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
      <div class="my_menu2">
        <button type="submit" class="btn btn-danger" name="button" value="choose">Escolher cliente</button>
      </div>
    </form>
  </div>
  {% elif success == 3 %}
    <div class="my_menu2">
      <div style="margin-top: 20px;" class="alert alert-danger">Nenhum cliente encontrado</div>
    </div>
    <form action="/adicionar_cliente/" method="GET">
      <div class="my_menu2">
        <button type="submit" class="btn btn-danger" name="button" value="add">Adicionar cliente</button>
      </div>
    </form>
  {% elif success == 4 %}
    <div class="my_menu2">
      <div style="margin-top: 20px;" class="alert alert-danger">Preencha pelo menos um campo</div>
    </div>
  {% endif %}
{% endblock %}


{% block script %}
  <script src="/static/js/js/bootstrap-select.min.js"></script>
  <script src="/static/js/js_datepicker/bootstrap-datepicker.min.js"></script>
  <script>
    $('.datepicker').datepicker();
    // creates an object with the types as keys and products as values
    var product_list = {
      // takes keys and values from the
      {% for tipo, query in products.items %}
        "{{ tipo }}": [
          {% for produto in query %}
            '{{ produto.nome }}',
          {% endfor %}
        ],
      {% endfor %}
    };

    function get_type(event) {
      $(document).ready(function (){
        $("#product_list").children().remove();
        var type = product_list[$("#product_type").val()].sort();
        for(var i = 0; i < type.length; i++){
          $("#product_list").append("<option>" + type[i] + "</option>");
          $('.selectpicker').selectpicker('refresh');
        }
      });
    }

    function validateForm() {
      var check = document.activeElement.value;
      // var list = ["Tipo", "Produto", "Quantidade", "Data"];
      var missing = false;
      if (check === "add"){
        var qtd = document.getElementById("quantidade").value;
        var pdt = document.getElementById("product_list").value;
        var confirmProduct = confirm("Você deseja adicionar o produto abaixo?\nProduto: " + pdt + "\nQuantidade: " + qtd);
        if (confirmProduct){
          $("#producao_form").attr("method", "POST");
          return true;
        }
        else{
          return false;
        }
      }
      else if (check === "filter"){
        $("#producao_form").attr("method", "GET");
        return true;
      }
    }



    function brPhoneStyle(event){
      var input = document.getElementById("telefone").value.replace(/\D/g, "");
      console.log(input);
      if(input.length === 10){
        document.getElementById("telefone").value = "(" + input.slice(0,2) + ")" + input.slice(2,6) + "-" + input.slice(-4);
      }
      else if(input.length === 11){
        document.getElementById("telefone").value = "(" + input.slice(0,2) + ")" + input.slice(2,7) + "-" + input.slice(-4);
      }else{
        document.getElementById("telefone").value = "";
      }
    }




  </script>
{% endblock %}
